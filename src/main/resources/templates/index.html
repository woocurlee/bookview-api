<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{layout :: head('BookView - 책 리뷰 플랫폼')}"></head>
<style>
    .review-quote {
        background: #f0f0f0;
        border-left: 4px solid #10b981;
        padding: 12px 16px;
        margin-bottom: 10px;
        font-style: italic;
        color: #555;
        border-radius: 4px;
    }
</style>
<body class="bg-gradient-to-br from-emerald-500 to-green-600 min-h-screen mb-10">
    <header th:replace="~{layout :: header}"></header>

    <div class="max-w-7xl mx-auto px-5">
        <!-- 리뷰 작성 유도 박스 -->
        <div sec:authorize="isAuthenticated()" th:if="${user != null}"
             onclick="goToWriteReview()"
             class="bg-white rounded-2xl p-5 mb-8 shadow-lg flex gap-4 items-center cursor-pointer transition-all hover:-translate-y-1 hover:shadow-xl">
            <img th:src="${user.profileImageUrl}" alt="프로필" th:if="${user.profileImageUrl}" class="w-12 h-12 rounded-full object-cover">
            <div th:unless="${user.profileImageUrl}" class="w-12 h-12 rounded-full bg-gradient-to-br from-emerald-500 to-green-600 flex items-center justify-center text-2xl text-white">✏️</div>
            <div class="flex-1 py-3 px-5 bg-gray-100 rounded-full text-gray-400 text-base">오늘 읽은 책에 대한 생각을 공유해보세요...</div>
        </div>

        <!-- 최근 리뷰 섹션 -->
        <section th:if="${reviews != null && !reviews.isEmpty()}">
            <div id="reviewsContainer" th:each="review : ${reviews}">
                <div class="bg-gray-50 rounded-xl p-5 mb-5 transition-all hover:-translate-y-1 hover:shadow-lg flex gap-5">
                    <img th:src="${review.bookThumbnail}"
                         alt="책 표지"
                         th:if="${review.bookThumbnail != null && !review.bookThumbnail.isEmpty()}"
                         class="h-48 object-cover rounded-lg flex-shrink-0">
                    <div class="flex-1">
                        <div class="text-xl font-bold mb-2 text-gray-800" th:text="${review.title}">리뷰 제목</div>
                        <div class="text-sm text-gray-600 mb-2.5">
                            <span th:text="${review.bookTitle}">책 제목</span> -
                            <span th:text="${review.bookAuthor}">저자</span>
                        </div>
                        <div class="text-yellow-400 mb-2.5">
                            <span th:each="i : ${#numbers.sequence(1, review.rating)}">★</span>
                            <span th:if="${review.rating < 5}" th:each="i : ${#numbers.sequence(review.rating + 1, 5)}">☆</span>
                        </div>
                        <div class="review-quote" th:if="${review.quote != null && !review.quote.isEmpty()}">
                            "<span th:text="${review.quote}"></span>"
                        </div>
                        <div class="text-gray-700 leading-relaxed mb-2.5 overflow-hidden line-clamp-3" th:utext="${review.content}">리뷰 내용...</div>
                        <div class="text-xs text-gray-400"
                             th:text="${#temporals.format(review.createdAt, 'yyyy-MM-dd HH:mm')}">
                            2024-12-24 10:00
                        </div>
                    </div>
                </div>
            </div>
            <div id="loading" class="text-center p-5 hidden">
                <p>로딩 중...</p>
            </div>
            <div id="endMessage" class="text-center p-5 text-gray-400 hidden">
                <p>모든 리뷰를 불러왔습니다.</p>
            </div>
        </section>
    </div>

    <script>
        let currentPage = 1;
        let isLoading = false;
        let hasMore = /*[[${hasMoreReviews}]]*/ true;

        function goToWriteReview() {
            window.location.href = '/write-review';
        }

        function searchBooks() {
            const query = document.getElementById('searchInput').value;
            if (query.trim()) {
                window.location.href = '/books?query=' + encodeURIComponent(query);
            }
        }

        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchBooks();
            }
        });

        // 무한 스크롤
        async function loadMoreReviews() {
            if (isLoading || !hasMore) return;

            isLoading = true;
            document.getElementById('loading').classList.remove('hidden');

            // 현재 스크롤 위치 저장
            const scrollHeight = document.documentElement.scrollHeight;

            try {
                const response = await fetch(`/api/reviews?page=${currentPage}&size=10`);
                const data = await response.json();

                if (data.reviews && data.reviews.length > 0) {
                    const container = document.getElementById('reviewsContainer');
                    data.reviews.forEach(review => {
                        const reviewCard = createReviewCard(review);
                        container.insertAdjacentHTML('beforeend', reviewCard);
                    });
                    currentPage++;
                    hasMore = data.hasMore;

                    // 스크롤 위치 조정
                    const newScrollHeight = document.documentElement.scrollHeight;
                    window.scrollTo(0, window.scrollY + (newScrollHeight - scrollHeight));
                } else {
                    hasMore = false;
                }

                if (!hasMore) {
                    document.getElementById('endMessage').classList.remove('hidden');
                }
            } catch (error) {
                console.error('리뷰 로딩 실패:', error);
            } finally {
                isLoading = false;
                document.getElementById('loading').classList.add('hidden');
            }
        }

        function createReviewCard(review) {
            const thumbnail = review.bookThumbnail
                ? `<img src="${review.bookThumbnail}" alt="책 표지" class="w-20 h-28 object-cover rounded-lg flex-shrink-0">`
                : '';

            const stars = '★'.repeat(review.rating) + '☆'.repeat(5 - review.rating);

            const quote = review.quote
                ? `<div class="review-quote">"${review.quote}"</div>`
                : '';

            return `
                <div class="bg-gray-50 rounded-xl p-5 mb-5 transition-all hover:-translate-y-1 hover:shadow-lg flex gap-5">
                    ${thumbnail}
                    <div class="flex-1">
                        <div class="text-xl font-bold mb-2 text-gray-800">${review.title}</div>
                        <div class="text-sm text-gray-600 mb-2.5">
                            <span>${review.bookTitle}</span> -
                            <span>${review.bookAuthor}</span>
                        </div>
                        <div class="text-yellow-400 mb-2.5">${stars}</div>
                        ${quote}
                        <div class="text-gray-700 leading-relaxed mb-2.5 overflow-hidden line-clamp-3">${review.content}</div>
                        <div class="text-xs text-gray-400">${new Date(review.createdAt).toLocaleString('ko-KR')}</div>
                    </div>
                </div>
            `;
        }

        // 스크롤 이벤트 리스너
        let scrollTimeout;
        window.addEventListener('scroll', () => {
            if (scrollTimeout) {
                clearTimeout(scrollTimeout);
            }
            scrollTimeout = setTimeout(() => {
                if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500) {
                    loadMoreReviews();
                }
            }, 100);
        });
    </script>
    <script th:replace="~{layout :: mobileMenuScript}"></script>
</body>
</html>
